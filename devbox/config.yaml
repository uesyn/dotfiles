default:
  podSpec:
    terminationGracePeriodSeconds: 3600
    containers:
    - image: ${DEVBOX_IMAGE}
      name: devbox
      lifecycle:
        preStop:
          exec:
            command:
            - /bin/bash
            - -c
            - |
              # Stop devbox when zellij and nvim are inactive or timeout is reached.
              touch /tmp/stopping
              end="\$(( \$(date +%s) + 3500 ))"

              while [[ "\$(date +%s)" -lt "\${end}" ]]; do
                [[ "\$(ps -lC zellij | wc -l)" -eq 1 ]] && break
                sleep 1s
              done

              while [[ "\$(date +%s)" -lt "\${end}" ]]; do
                [[ "\$(ps -lC nvim | wc -l)" -eq 1 ]] && break
                sleep 1s
              done

              rm /tmp/stopping
              sudo pkill supervisord
      securityContext:
        privileged: true
      volumeMounts:
      - name: tmp
        mountPath: /tmp
      - name: docker
        mountPath: /var/lib/docker
      - name: data
        mountPath: /home/devbox
    volumes:
    - name: tmp
      emptyDir: {}
    - name: docker
      emptyDir: {}
    - name: data
      persistentVolumeClaim:
        claimName: data
  persistentVolumeClaims:
    data:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 50Gi
  exec:
    shell: zsh
    hostEnvs:
    - GITHUB_TOKEN
